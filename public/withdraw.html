<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Withdraw Funds</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: Poppins, Arial, sans-serif;
      background: #f6f7fb;
      padding: 20px;
      color: #222;
    }
    .card {
      max-width: 420px;
      margin: 18px auto;
      background: #fff;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 15px;
    }
    button {
      background: #1766d1;
      color: #fff;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: 0.2s ease;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
      opacity: 0.7;
    }
    button:disabled:hover {
      background: #999;
    }
    .error-message {
      color: #dc2626;
      font-size: 14px;
      margin: 8px 0;
      text-align: center;
      display: none;
    }
    .success-message {
      color: #16a34a;
      font-size: 14px;
      margin: 8px 0;
      text-align: center;
      display: none;
    }
    .bank-details {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    .bank-details h4 {
      margin: 0 0 8px 0;
      color: #1766d1;
    }
    .refresh-btn {
      background: #f59e0b;
      margin-top: 10px;
    }
    table {
      width: 100%;
      margin-top: 18px;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8fafc;
      font-weight: 600;
    }
    .status-pending { color: #f59e0b; font-weight: 600; }
    .status-approved { color: #16a34a; font-weight: 600; }
    .status-rejected { color: #dc2626; font-weight: 600; }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .debug-info {
      background: #e2e8f0;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 12px;
      color: #4a5568;
      display: none; /* Hide by default, show for debugging */
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Withdraw Funds</h2>
    <div>Balance: ‚Ç¶<strong id="balance">0.00</strong></div>

    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info"></div>

    <!-- Bank Details Display -->
    <div id="bankDetailsInfo" class="bank-details" style="display: none;">
      <h4>üè¶ Your Bank Details</h4>
      <div><strong>Account Name:</strong> <span id="displayAccountName"></span></div>
      <div><strong>Account Number:</strong> <span id="displayAccountNumber"></span></div>
      <div><strong>Bank:</strong> <span id="displayBankName"></span></div>
      <button type="button" class="refresh-btn" onclick="refreshBankDetails()">üîÑ Refresh Bank Details</button>
      <small style="color: #64748b; display: block; margin-top: 8px;">To update these details, go to <a href="account.html" style="color: #1766d1;">Account Settings</a></small>
    </div>

    <div id="noBankDetails" class="error-message">
      ‚ùå You need to add your bank details before withdrawing. 
      <a href="account.html" style="color: #1766d1; font-weight: 600;">Add Bank Details</a>
      <button type="button" class="refresh-btn" onclick="refreshBankDetails()" style="margin-top: 10px;">üîÑ Check Again</button>
    </div>

    <form id="withdrawForm" style="display: none;">
      <input type="number" id="amount" placeholder="Amount (min ‚Ç¶1000)" required min="1000" />
      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>
      <button id="submitBtn" type="submit">Submit Withdrawal Request</button>
    </form>
  </div>

  <div class="card" style="max-width:800px;">
    <h3>Your Withdrawal History</h3>
    <table>
      <thead>
        <tr>
          <th>Amount</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="withdrawHistory"></tbody>
    </table>
  </div>

<script>
  const API_BASE = "https://gaming-continental.onrender.com";
  
  // Get elements
  const balanceEl = document.getElementById("balance");
  const submitBtn = document.getElementById("submitBtn");
  const withdrawForm = document.getElementById("withdrawForm");
  const bankDetailsInfo = document.getElementById("bankDetailsInfo");
  const noBankDetails = document.getElementById("noBankDetails");
  const errorMessage = document.getElementById("errorMessage");
  const successMessage = document.getElementById("successMessage");
  const debugInfo = document.getElementById("debugInfo");

  let user = null;
  let userId = null;

  // ‚úÖ IMPROVED: Check for bank details with multiple fallbacks
  function hasBankDetails(userData) {
    if (!userData) return false;
    
    // Check multiple possible structures
    const bankDetails = userData.bankDetails;
    
    // Structure 1: bankDetails object with accountNumber
    if (bankDetails && bankDetails.accountNumber && bankDetails.accountNumber.toString().trim().length >= 10) {
      return true;
    }
    
    // Structure 2: Direct properties on user object
    if (userData.accountNumber && userData.accountNumber.toString().trim().length >= 10) {
      return true;
    }
    
    // Structure 3: Check if bankDetails exists but might have different structure
    if (bankDetails && typeof bankDetails === 'object') {
      // Check all properties to see if any look like account numbers
      for (let key in bankDetails) {
        const value = bankDetails[key];
        if (typeof value === 'string' && /^\d{10,}$/.test(value.trim())) {
          return true;
        }
      }
    }
    
    return false;
  }

  // ‚úÖ IMPROVED: Get bank details with multiple fallbacks
  function getBankDetails(userData) {
    if (!userData) return null;
    
    const bankDetails = userData.bankDetails || {};
    const result = {
      accountName: '',
      accountNumber: '',
      bankName: ''
    };
    
    // Try to extract account number from multiple possible locations
    if (bankDetails.accountNumber) {
      result.accountNumber = bankDetails.accountNumber.toString().trim();
    } else if (userData.accountNumber) {
      result.accountNumber = userData.accountNumber.toString().trim();
    }
    
    // Try to extract bank name from multiple possible locations
    if (bankDetails.bankName) {
      result.bankName = bankDetails.bankName.toString().trim();
    } else if (userData.bankName) {
      result.bankName = userData.bankName.toString().trim();
    }
    
    // Try to extract account name from multiple possible locations
    if (bankDetails.accountName) {
      result.accountName = bankDetails.accountName.toString().trim();
    } else if (userData.accountName) {
      result.accountName = userData.accountName.toString().trim();
    } else if (userData.firstName || userData.lastName) {
      result.accountName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
    }
    
    return result;
  }

  // üîí Protect page and initialize
  function initializePage() {
    user = JSON.parse(localStorage.getItem("user") || "{}");
    userId = user?._id || user?.id || user?.userId;

    if (!userId) {
      alert("Please login first");
      window.location.href = "index.html";
      return;
    }

    console.log("üîÑ Initializing withdraw page...");
    console.log("üìã Full user data:", user);
    console.log("üè¶ Bank details object:", user?.bankDetails);
    console.log("üîç Has bank details check:", hasBankDetails(user));

    // Show debug info
    showDebugInfo();

    // Show data immediately from localStorage
    displayUserData(user);
    
    // Then force refresh from server
    forceRefreshUserData();
    
    // Load history
    loadHistory();
  }

  // ‚úÖ Show debug information
  function showDebugInfo() {
    const debugHtml = `
      <strong>Debug Info:</strong><br>
      User ID: ${userId}<br>
      Has Bank Details: ${hasBankDetails(user)}<br>
      Bank Details Object: ${JSON.stringify(user?.bankDetails || {})}<br>
      Account Number: ${user?.bankDetails?.accountNumber || 'NOT FOUND'}<br>
      Bank Name: ${user?.bankDetails?.bankName || 'NOT FOUND'}
    `;
    debugInfo.innerHTML = debugHtml;
    debugInfo.style.display = 'block'; // Show debug info
  }

  // ‚úÖ Display user data immediately
  function displayUserData(userData) {
    console.log("üîÑ Displaying user data");
    
    // Update balance
    balanceEl.innerText = (userData.balance || 0).toFixed(2);
    
    // Check if user has bank details
    const hasDetails = hasBankDetails(userData);
    const bankDetails = getBankDetails(userData);
    
    console.log("üè¶ Bank details analysis:", {
      hasDetails: hasDetails,
      extractedDetails: bankDetails,
      rawBankDetails: userData?.bankDetails
    });

    if (hasDetails && bankDetails.accountNumber) {
      // Show bank details and withdraw form
      bankDetailsInfo.style.display = 'block';
      withdrawForm.style.display = 'block';
      noBankDetails.style.display = 'none';
      
      // Display bank details
      document.getElementById('displayAccountName').textContent = bankDetails.accountName || "Not provided";
      document.getElementById('displayAccountNumber').textContent = bankDetails.accountNumber;
      document.getElementById('displayBankName').textContent = bankDetails.bankName || "Not provided";
      
      console.log("‚úÖ Bank details found and displayed");
    } else {
      // Show error and hide form
      bankDetailsInfo.style.display = 'none';
      withdrawForm.style.display = 'none';
      noBankDetails.style.display = 'block';
      console.log("‚ùå No valid bank details found");
      
      // Show what we found for debugging
      console.log("üîç What we found instead:", {
        bankDetails: userData?.bankDetails,
        accountNumber: userData?.accountNumber,
        bankName: userData?.bankName
      });
    }
  }

  // ‚úÖ Force refresh user data from server
  async function forceRefreshUserData() {
    if (!userId) return;

    try {
      console.log("üîÑ Fetching fresh user data from server...");
      
      // Use the auth/me endpoint that works with your backend
      const res = await fetch(`${API_BASE}/auth/me?userId=${userId}`);
      
      if (res.ok) {
        const freshUser = await res.json();
        
        console.log("‚úÖ Fresh user data from server:", freshUser);
        
        // Update localStorage with fresh data
        localStorage.setItem("user", JSON.stringify(freshUser));
        user = freshUser;
        
        // Update debug info
        showDebugInfo();
        
        // Update display with fresh data
        displayUserData(freshUser);
        console.log("‚úÖ User data refreshed successfully");
        
        showTempMessage("‚úÖ Bank details updated!", false);
      } else {
        console.log("‚ùå Failed to refresh user data from server");
        showTempMessage("‚ö†Ô∏è Using cached data", true);
      }
      
    } catch (err) {
      console.error("Error refreshing user:", err);
      showTempMessage("‚ùå Failed to refresh data", true);
    }
  }

  // ‚úÖ Manual refresh function
  async function refreshBankDetails() {
    showTempMessage("üîÑ Refreshing...", false);
    await forceRefreshUserData();
  }

  // ‚úÖ Show temporary message
  function showTempMessage(message, isError) {
    const tempDiv = document.createElement('div');
    tempDiv.textContent = message;
    tempDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${isError ? '#dc2626' : '#16a34a'};
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    document.body.appendChild(tempDiv);
    
    setTimeout(() => {
      document.body.removeChild(tempDiv);
    }, 3000);
  }

  // Withdraw form submission
  document.getElementById("withdrawForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const amount = Number(document.getElementById("amount").value);
    
    // Validation
    if (!amount || amount < 1000) {
      showFormMessage("Minimum withdrawal is ‚Ç¶1000", true);
      return;
    }

    if (amount > (user?.balance || 0)) {
      showFormMessage(`Insufficient balance. Your balance is ‚Ç¶${(user?.balance || 0).toFixed(2)}`, true);
      return;
    }

    // Disable button while processing
    submitBtn.disabled = true;
    submitBtn.textContent = "Processing...";
    showFormMessage("", false);

    try {
      const res = await fetch(`${API_BASE}/withdraw`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          userId: userId,
          amount: amount,
          method: "Bank Transfer"
        })
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || data.message || "Withdrawal failed");
      }

      showFormMessage("‚úÖ Withdrawal request submitted! Waiting for admin approval.", false);
      document.getElementById("amount").value = "";
      
      // Refresh user data and history
      await forceRefreshUserData();
      await loadHistory();
      
    } catch (err) {
      console.error("Withdraw error:", err);
      showFormMessage("‚ùå " + err.message, true);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Withdrawal Request";
    }
  });

  // Show form message
  function showFormMessage(message, isError) {
    if (isError) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    } else {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }
  }

  // Load withdrawal history
  async function loadHistory() {
    if (!userId) return;

    try {
      const res = await fetch(`${API_BASE}/user/transactions?userId=${userId}`);
      
      if (!res.ok) {
        throw new Error("Failed to load history");
      }
      
      const transactions = await res.json();
      const tbody = document.getElementById("withdrawHistory");
      tbody.innerHTML = "";
      
      const withdrawals = transactions.filter(t => t.type === 'withdraw');
      
      if (withdrawals.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#64748b;">No withdrawal history found</td></tr>`;
        return;
      }
      
      withdrawals.forEach(w => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>‚Ç¶${Number(w.amount).toLocaleString()}</td>
          <td class="status-${w.status}">${w.status.toUpperCase()}</td>
          <td>${new Date(w.createdAt || w.date).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
      
    } catch (err) {
      console.error("Error loading history:", err);
      
      const tbody = document.getElementById("withdrawHistory");
      tbody.innerHTML = `
        <tr>
          <td colspan="3" style="text-align:center; color:#64748b;">
            Withdrawal history will appear here after your first withdrawal
          </td>
        </tr>
      `;
    }
  }

  // Check for bank details
  function startBankDetailsChecker() {
    setInterval(() => {
      const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
      const hasBankDetails = hasBankDetails(currentUser);
      
      if (hasBankDetails && noBankDetails.style.display !== 'none') {
        console.log("üîÑ Auto-detected bank details, refreshing display...");
        displayUserData(currentUser);
      }
    }, 2000);
  }

  // Initialize when page loads
  document.addEventListener("DOMContentLoaded", () => {
    console.log("üöÄ Withdraw page loaded");
    initializePage();
    startBankDetailsChecker();
  });

</script>
</body>
</html>