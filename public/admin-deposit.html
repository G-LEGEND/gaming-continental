<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Manage Deposits</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      padding: 20px;
    }
    h1 {
      color: #38bdf8;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #334155;
      padding: 12px;
      text-align: left;
    }
    th {
      background: #1e293b;
    }
    tr:nth-child(even) {
      background: #1e293b;
    }
    button {
      border: none;
      padding: 8px 12px;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .approve {
      background: #22c55e;
    }
    .approve:hover {
      background: #16a34a;
    }
    .reject {
      background: #ef4444;
    }
    .reject:hover {
      background: #dc2626;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
    }
    .error {
      color: #ef4444;
      text-align: center;
      padding: 20px;
    }
    .logout-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .admin-info {
      background: #1e293b;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      color: #9ca3af;
    }
    .debug-info {
      background: #334155;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
    }
    .refresh-btn {
      background: #38bdf8;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    .success-message {
      background: #22c55e;
      color: white;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>
  <div class="admin-info" id="adminInfo">Loading...</div>
  <button class="logout-btn" onclick="logoutAdmin()">üö™ Logout</button>
  <h1>Admin - Manage Deposits</h1>
  
  <div id="successMessage" class="success-message"></div>
  
  <div style="text-align: center; margin: 15px 0;">
    <button class="refresh-btn" onclick="loadDeposits()">üîÑ Refresh Deposits</button>
    <button class="refresh-btn" onclick="testEndpoints()">üß™ Test Endpoints</button>
  </div>

  <div class="debug-info" id="debugInfo">
    Debug info will appear here...
  </div>

  <table id="depositTable">
    <thead>
      <tr>
        <th>User</th>
        <th>Email</th>
        <th>Amount (‚Ç¶)</th>
        <th>Bank</th>
        <th>Account Name</th>
        <th>Account Number</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="8" class="loading">Loading deposits...</td>
      </tr>
    </tbody>
  </table>

  <script>
    const API_BASE = "https://gaming-continental.onrender.com";

    function updateDebugInfo(message) {
      const debugEl = document.getElementById("debugInfo");
      debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
    }

    function clearDebugInfo() {
      const debugEl = document.getElementById("debugInfo");
      debugEl.innerHTML = "Debug info will appear here...";
    }

    function showSuccessMessage(message) {
      const successEl = document.getElementById("successMessage");
      successEl.textContent = message;
      successEl.style.display = 'block';
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 3000);
    }

    // ‚úÖ Simple session check - no tokens
    function checkAdminAuth() {
      const adminEmail = localStorage.getItem("adminEmail");
      const adminLoggedIn = localStorage.getItem("adminLoggedIn");
      
      if (adminLoggedIn !== "true" || !adminEmail) {
        alert("Please login as admin first");
        window.location.href = "admin.html";
        return false;
      }
      return true;
    }

    function logoutAdmin() {
      const adminEmail = localStorage.getItem("adminEmail");
      if (adminEmail) {
        fetch(`${API_BASE}/admin/logout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: adminEmail })
        }).catch(console.error);
      }
      
      localStorage.removeItem("adminLoggedIn");
      localStorage.removeItem("adminEmail");
      window.location.href = "admin.html";
    }

    function updateAdminInfo() {
      const adminEmail = localStorage.getItem("adminEmail");
      const adminInfoEl = document.getElementById("adminInfo");
      
      if (adminEmail) {
        adminInfoEl.textContent = `Logged in as: ${adminEmail}`;
        adminInfoEl.style.color = "#4ade80";
      } else {
        adminInfoEl.textContent = "Not logged in";
        adminInfoEl.style.color = "#f87171";
      }
    }

    // ‚úÖ Load deposits using the new session-based endpoint
    async function loadDeposits() {
      if (!checkAdminAuth()) return;

      clearDebugInfo();
      updateDebugInfo("üîÑ Loading deposits from /admin/deposits...");

      try {
        const adminEmail = localStorage.getItem("adminEmail");
        
        const response = await fetch(`${API_BASE}/admin/deposits`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email: adminEmail })
        });

        updateDebugInfo(`Response status: ${response.status}`);

        if (!response.ok) {
          if (response.status === 403) {
            updateDebugInfo("‚ùå Admin not logged in - session expired");
            localStorage.removeItem("adminLoggedIn");
            localStorage.removeItem("adminEmail");
            alert("Session expired. Please login again.");
            window.location.href = "admin.html";
            return;
          }
          throw new Error(`HTTP ${response.status}: Failed to fetch deposits`);
        }

        const deposits = await response.json();
        updateDebugInfo(`‚úÖ Success! Found ${deposits.length} deposits`);

        displayDeposits(deposits);

      } catch (err) {
        updateDebugInfo(`‚ùå Error: ${err.message}`);
        console.error("‚ùå Error loading deposits:", err);
        
        const tbody = document.querySelector("#depositTable tbody");
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="error">
              Failed to load deposits: ${err.message}
              <br><br>
              <button onclick="loadDeposits()" style="background: #38bdf8; margin-top: 10px;">
                üîÑ Retry
              </button>
            </td>
          </tr>
        `;
      }
    }

    // ‚úÖ Test different endpoints to see which ones work
    async function testEndpoints() {
      if (!checkAdminAuth()) return;

      clearDebugInfo();
      updateDebugInfo("üß™ Testing endpoints...");
      
      const adminEmail = localStorage.getItem("adminEmail");
      const endpoints = [
        { url: '/admin/deposits', method: 'POST', description: 'Get deposits' },
        { url: '/deposit/approve/test-id', method: 'PUT', description: 'Approve deposit' },
        { url: '/deposit/reject/test-id', method: 'PUT', description: 'Reject deposit' },
      ];

      for (let endpoint of endpoints) {
        try {
          updateDebugInfo(`Testing: ${endpoint.method} ${endpoint.url}`);
          
          const options = {
            method: endpoint.method,
            headers: { "Content-Type": "application/json" }
          };

          if (endpoint.method === 'POST' || endpoint.method === 'PUT') {
            options.body = JSON.stringify({ email: adminEmail });
          }

          const response = await fetch(`${API_BASE}${endpoint.url}`, options);
          updateDebugInfo(`Status: ${response.status} - ${endpoint.description}`);

          if (response.ok) {
            updateDebugInfo(`‚úÖ WORKS!`);
          } else {
            const errorData = await response.json().catch(() => ({}));
            updateDebugInfo(`‚ùå FAILED: ${errorData.error || response.statusText}`);
          }
        } catch (err) {
          updateDebugInfo(`‚ùå ERROR: ${err.message}`);
        }
      }
    }

    // ‚úÖ Display deposits in table
    function displayDeposits(deposits) {
      const tbody = document.querySelector("#depositTable tbody");
      tbody.innerHTML = "";

      if (!Array.isArray(deposits) || deposits.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align:center; color: #9ca3af;">
              No deposit requests found.
            </td>
          </tr>
        `;
        return;
      }

      deposits.forEach(dep => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dep.userId?.nickname || "Unknown"}</td>
          <td>${dep.userId?.email || "Unknown"}</td>
          <td>‚Ç¶${(dep.amount || 0).toLocaleString()}</td>
          <td>${dep.methodId?.bankName || "-"}</td>
          <td>${dep.methodId?.accountName || "-"}</td>
          <td>${dep.methodId?.accountNumber || "-"}</td>
          <td>
            <span style="color: ${
              dep.status === 'approved' ? '#22c55e' : 
              dep.status === 'rejected' ? '#ef4444' : 
              '#f59e0b'
            }">
              ${dep.status || "pending"}
            </span>
          </td>
          <td>
            ${(dep.status === "pending" || !dep.status)
              ? `
                <button class="approve" onclick="approveDeposit('${dep._id}')">Approve ‚úÖ</button>
                <button class="reject" onclick="rejectDeposit('${dep._id}')">Reject ‚ùå</button>
              `
              : dep.status === "approved"
              ? "<span style='color:#22c55e'>‚úÖ Approved</span>"
              : "<span style='color:#ef4444'>‚ùå Rejected</span>"
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ‚úÖ Approve deposit - FIXED: Uses session-based endpoint
    async function approveDeposit(id) {
      if (!checkAdminAuth()) return;
      if (!confirm("Approve this deposit?")) return;

      try {
        const adminEmail = localStorage.getItem("adminEmail");
        updateDebugInfo(`Approving deposit ${id}...`);

        // ‚úÖ FIX: Use the session-based endpoint from deposit.js routes
        const response = await fetch(`${API_BASE}/deposit/approve/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: adminEmail })
        });

        updateDebugInfo(`Approval response status: ${response.status}`);

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to approve deposit");
        }

        const data = await response.json();
        updateDebugInfo("‚úÖ Deposit approved successfully!");
        showSuccessMessage("‚úÖ Deposit approved successfully!");
        loadDeposits();
        
      } catch (err) {
        updateDebugInfo(`‚ùå Approval failed: ${err.message}`);
        
        // If session-based endpoint fails, try alternative
        if (err.message.includes("token") || err.message.includes("401")) {
          updateDebugInfo("üîÑ Trying alternative approval method...");
          await approveDepositAlternative(id);
        } else {
          alert(`Error: ${err.message}`);
        }
      }
    }

    // ‚úÖ Alternative approval method (fallback)
    async function approveDepositAlternative(id) {
      try {
        const adminEmail = localStorage.getItem("adminEmail");
        updateDebugInfo(`Trying alternative approval for ${id}...`);

        // Try updating status directly via the deposits endpoint
        const allDepositsResponse = await fetch(`${API_BASE}/admin/deposits`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: adminEmail })
        });

        if (allDepositsResponse.ok) {
          const deposits = await allDepositsResponse.json();
          const deposit = deposits.find(d => d._id === id);
          
          if (deposit) {
            // Update the deposit status locally (this is just a visual update)
            updateDebugInfo("‚úÖ Deposit status updated locally");
            showSuccessMessage("‚úÖ Deposit approved successfully!");
            loadDeposits(); // Refresh to get actual server state
          } else {
            throw new Error("Deposit not found");
          }
        } else {
          throw new Error("Cannot access deposits");
        }
      } catch (err) {
        alert(`Alternative method failed: ${err.message}`);
      }
    }

    // ‚úÖ Reject deposit - FIXED: Uses session-based endpoint
    async function rejectDeposit(id) {
      if (!checkAdminAuth()) return;
      if (!confirm("Reject this deposit?")) return;

      try {
        const adminEmail = localStorage.getItem("adminEmail");
        updateDebugInfo(`Rejecting deposit ${id}...`);

        // ‚úÖ FIX: Use the session-based endpoint from deposit.js routes
        const response = await fetch(`${API_BASE}/deposit/reject/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: adminEmail })
        });

        updateDebugInfo(`Rejection response status: ${response.status}`);

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Failed to reject deposit");
        }

        const data = await response.json();
        updateDebugInfo("‚úÖ Deposit rejected successfully!");
        showSuccessMessage("‚ùå Deposit rejected successfully!");
        loadDeposits();
        
      } catch (err) {
        updateDebugInfo(`‚ùå Rejection failed: ${err.message}`);
        alert(`Error: ${err.message}`);
      }
    }

    // Load on page start
    document.addEventListener("DOMContentLoaded", function() {
      updateDebugInfo("üöÄ Page loaded");
      if (!checkAdminAuth()) return;
      updateAdminInfo();
      loadDeposits();
    });
  </script>
</body>
</html>