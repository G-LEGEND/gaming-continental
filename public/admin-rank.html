<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Global Leaderboard | Gaming Continental</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #0f172a;
      margin: 0;
      padding: 15px;
      color: #f8fafc;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #38bdf8;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .search-box {
      flex: 1;
      min-width: 200px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #f1f5f9;
      border-radius: 6px;
      font-size: 15px;
      outline: none;
    }
    input[type="text"]::placeholder {
      color: #94a3b8;
    }
    .refresh-btn {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.3s;
    }
    .refresh-btn:hover { 
      background: #1d4ed8; 
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e293b;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    th, td {
      text-align: center;
      padding: 12px 10px;
      border-bottom: 1px solid #334155;
    }
    th {
      background: #2563eb;
      color: white;
      font-size: 14px;
      text-transform: uppercase;
    }
    tr:hover {
      background: #273549;
    }
    .rank-badge {
      font-size: 18px;
      font-weight: bold;
    }
    .gold { color: #facc15; }
    .silver { color: #e2e8f0; }
    .bronze { color: #f59e0b; }
    .save-btn {
      background: #22c55e;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    .save-btn:hover { 
      background: #16a34a; 
    }
    .points-input {
      width: 70px;
      text-align: center;
      padding: 5px;
      border: 1px solid #334155;
      border-radius: 5px;
      font-size: 14px;
      background: #0f172a;
      color: white;
    }
    select {
      background: #0f172a;
      color: white;
      border: 1px solid #334155;
      border-radius: 5px;
      padding: 4px 6px;
    }
    .no-data {
      text-align: center;
      color: #94a3b8;
      padding: 25px;
      font-style: italic;
    }
    .admin-info {
      background: #1e293b;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      border-left: 4px solid #2563eb;
    }
    .logout-btn {
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      margin-left: 10px;
    }
    .logout-btn:hover { 
      background: #b91c1c; 
    }
    @media (max-width: 700px) {
      body { padding: 10px; }
      th, td { font-size: 13px; padding: 8px; }
      .top-bar { flex-direction: column; }
      .refresh-btn { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>üèÜ Admin Global Leaderboard</h1>

  <!-- Admin Info Bar -->
  <div class="admin-info">
    <strong>Logged in as:</strong> <span id="adminEmail"></span>
    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
  </div>

  <div class="top-bar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by nickname or email..." oninput="filterUsers()">
    </div>
    <button class="refresh-btn" onclick="loadRanks()">üîÑ Refresh</button>
  </div>

  <table id="rankTable">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nickname</th>
        <th>Email</th>
        <th>FIFA Points</th>
        <th>Snooker Points</th>
        <th>Total Points</th>
        <th>Add Points</th>
        <th>Date Joined</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_BASE = "https://gaming-continental.onrender.com";
    const tbody = document.querySelector("#rankTable tbody");
    let usersData = [];

    // Check if admin is logged in
    function checkAdminAuth() {
      const adminLoggedIn = localStorage.getItem("adminLoggedIn");
      const adminEmail = localStorage.getItem("adminEmail");
      
      if (!adminLoggedIn || !adminEmail) {
        alert("Please log in as admin first.");
        window.location.href = "admin.html";
        return false;
      }
      
      document.getElementById("adminEmail").textContent = adminEmail;
      return true;
    }

    // Logout function
    async function logout() {
      const adminEmail = localStorage.getItem("adminEmail");
      
      try {
        if (adminEmail) {
          await fetch(API_BASE + "/admin/logout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: adminEmail })
          });
        }
      } catch (err) {
        console.error("Logout error:", err);
      } finally {
        localStorage.removeItem("adminLoggedIn");
        localStorage.removeItem("adminEmail");
        localStorage.removeItem("loginTime");
        window.location.href = "admin.html";
      }
    }

    // Load Leaderboard
    async function loadRanks() {
      if (!checkAdminAuth()) return;

      const adminEmail = localStorage.getItem("adminEmail");

      try {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">Loading leaderboard...</td></tr>';
        
        const res = await fetch(API_BASE + "/admin/rank/all", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: adminEmail })
        });
        
        const users = await res.json();
        
        if (!res.ok) {
          throw new Error(users.error || "Failed to load rank");
        }

        usersData = users.map(function(u) {
          return {
            ...u,
            totalPoints: (u.fifaPoints || 0) + (u.snookerPoints || 0)
          };
        }).sort(function(a, b) {
          return b.totalPoints - a.totalPoints;
        });

        renderTable(usersData);
      } catch (err) {
        console.error("Load rank error:", err);
        if (err.message.includes("not logged in") || err.message.includes("Session")) {
          alert("Session expired. Please log in again.");
          logout();
          return;
        }
        tbody.innerHTML = '<tr><td colspan="8" class="no-data" style="color:#f87171;">' + err.message + '</td></tr>';
      }
    }

    // Render Leaderboard Table
    function renderTable(data) {
      tbody.innerHTML = "";
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No users found.</td></tr>';
        return;
      }

      data.forEach(function(u, i) {
        const pos = i + 1;
        let badgeClass = "";
        let medal = "";
        if (pos === 1) { 
          badgeClass = "gold"; 
          medal = "ü•á"; 
        } else if (pos === 2) { 
          badgeClass = "silver"; 
          medal = "ü•à"; 
        } else if (pos === 3) { 
          badgeClass = "bronze"; 
          medal = "ü•â"; 
        }

        const tr = document.createElement("tr");
        tr.innerHTML = 
          '<td class="rank-badge ' + badgeClass + '">' + pos + ' ' + medal + '</td>' +
          '<td>' + (u.nickname || "‚Äî") + '</td>' +
          '<td>' + u.email + '</td>' +
          '<td>' + (u.fifaPoints || 0) + '</td>' +
          '<td>' + (u.snookerPoints || 0) + '</td>' +
          '<td><b>' + u.totalPoints + '</b></td>' +
          '<td>' +
          '<select id="cat-' + u._id + '">' +
          '<option value="fifa">FIFA</option>' +
          '<option value="snooker">Snooker</option>' +
          '</select>' +
          '<input type="number" id="points-' + u._id + '" class="points-input" placeholder="Add">' +
          '<button class="save-btn" onclick="addPoints(\'' + u._id + '\')">Save</button>' +
          '</td>' +
          '<td>' + (u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '‚Äî') + '</td>';
        tbody.appendChild(tr);
      });
    }

    // Add Points to a User
    async function addPoints(userId) {
      if (!checkAdminAuth()) return;

      const adminEmail = localStorage.getItem("adminEmail");
      const category = document.getElementById("cat-" + userId).value;
      const pointsInput = document.getElementById("points-" + userId);
      const points = parseInt(pointsInput.value);

      if (!points || points <= 0) {
        alert("Enter valid points");
        return;
      }

      try {
        const res = await fetch(API_BASE + "/admin/rank/add-points/" + userId, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            category: category, 
            points: points,
            email: adminEmail
          })
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || "Failed to add points");
        }

        alert("‚úÖ " + data.message);
        loadRanks();
      } catch (err) {
        console.error("Add points error:", err);
        if (err.message.includes("not logged in") || err.message.includes("Session")) {
          alert("Session expired. Please log in again.");
          logout();
          return;
        }
        alert("‚ùå " + err.message);
      }
    }

    // Search / Filter
    function filterUsers() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const filtered = usersData.filter(function(u) {
        return (u.nickname && u.nickname.toLowerCase().includes(search)) ||
               (u.email && u.email.toLowerCase().includes(search));
      });
      renderTable(filtered);
    }

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", function() {
      if (checkAdminAuth()) {
        loadRanks();
      }
    });
  </script>
</body>
</html>