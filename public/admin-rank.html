<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Global Leaderboard | Gaming Continental</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      margin: 0;
      padding: 15px;
      color: #f8fafc;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #38bdf8;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .search-box {
      flex: 1;
      min-width: 200px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #f1f5f9;
      border-radius: 6px;
      font-size: 15px;
      outline: none;
    }
    input[type="text"]::placeholder {
      color: #94a3b8;
    }
    .refresh-btn {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
    }
    .refresh-btn:hover { 
      background: #1d4ed8; 
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e293b;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      text-align: center;
      padding: 12px 10px;
      border-bottom: 1px solid #334155;
    }
    th {
      background: #2563eb;
      color: white;
      font-size: 14px;
      text-transform: uppercase;
    }
    tr:hover {
      background: #273549;
    }
    .rank-badge {
      font-size: 18px;
      font-weight: bold;
    }
    .gold { color: #facc15; }
    .silver { color: #e2e8f0; }
    .bronze { color: #f59e0b; }
    .save-btn {
      background: #22c55e;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .save-btn:hover { 
      background: #16a34a; 
    }
    .points-input {
      width: 70px;
      text-align: center;
      padding: 5px;
      border: 1px solid #334155;
      border-radius: 5px;
      font-size: 14px;
      background: #0f172a;
      color: white;
    }
    select {
      background: #0f172a;
      color: white;
      border: 1px solid #334155;
      border-radius: 5px;
      padding: 4px 6px;
    }
    .no-data {
      text-align: center;
      color: #94a3b8;
      padding: 25px;
      font-style: italic;
    }
    .admin-info {
      background: #1e293b;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      border-left: 4px solid #2563eb;
    }
    .logout-btn {
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      margin-left: 10px;
    }
    .logout-btn:hover { 
      background: #b91c1c; 
    }
  </style>
</head>
<body>
  <h1>üèÜ Admin Global Leaderboard</h1>

  <div class="admin-info">
    <strong>Logged in as:</strong> <span id="adminEmail"></span>
    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
  </div>

  <div class="top-bar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by nickname or email..." oninput="filterUsers()">
    </div>
    <button class="refresh-btn" onclick="loadRanks()">üîÑ Refresh</button>
  </div>

  <table id="rankTable">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nickname</th>
        <th>Email</th>
        <th>FIFA Points</th>
        <th>Snooker Points</th>
        <th>Total Points</th>
        <th>Add Points</th>
        <th>Date Joined</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    // Global variables
    var API_BASE = "https://gaming-continental.onrender.com";
    var usersData = [];

    // Check if admin is logged in
    function checkAdminAuth() {
      var adminLoggedIn = localStorage.getItem("adminLoggedIn");
      var adminEmail = localStorage.getItem("adminEmail");
      
      if (!adminLoggedIn || !adminEmail) {
        alert("Please log in as admin first.");
        window.location.href = "admin.html";
        return false;
      }
      
      document.getElementById("adminEmail").textContent = adminEmail;
      return true;
    }

    // Logout function
    function logout() {
      var adminEmail = localStorage.getItem("adminEmail");
      
      // Call logout endpoint
      fetch(API_BASE + "/admin/logout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: adminEmail })
      }).catch(function(err) {
        console.log("Logout error:", err);
      });
      
      // Clear storage and redirect
      localStorage.removeItem("adminLoggedIn");
      localStorage.removeItem("adminEmail");
      localStorage.removeItem("loginTime");
      window.location.href = "admin.html";
    }

    // Load Leaderboard - USING PUBLIC ENDPOINT
    function loadRanks() {
      if (!checkAdminAuth()) return;

      var tbody = document.getElementById("tableBody");

      // Show loading
      tbody.innerHTML = '<tr><td colspan="8" class="no-data">Loading leaderboard...</td></tr>';
      
      // Use PUBLIC endpoint to get all users (no auth required)
      fetch(API_BASE + "/user/all")
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(function(users) {
        console.log("Users loaded:", users);

        // Process users data
        usersData = [];
        for (var i = 0; i < users.length; i++) {
          var user = users[i];
          var fifaPoints = user.fifaPoints || 0;
          var snookerPoints = user.snookerPoints || 0;
          var totalPoints = fifaPoints + snookerPoints;
          
          usersData.push({
            _id: user._id,
            nickname: user.nickname,
            email: user.email,
            fifaPoints: fifaPoints,
            snookerPoints: snookerPoints,
            totalPoints: totalPoints,
            createdAt: user.createdAt
          });
        }

        // Sort by total points
        usersData.sort(function(a, b) {
          return b.totalPoints - a.totalPoints;
        });

        renderTable(usersData);
      })
      .catch(function(err) {
        console.error("Load rank error:", err);
        tbody.innerHTML = '<tr><td colspan="8" class="no-data" style="color:#f87171;">Failed to load users: ' + err.message + '</td></tr>';
      });
    }

    // Render Leaderboard Table
    function renderTable(data) {
      var tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No users found.</td></tr>';
        return;
      }

      for (var i = 0; i < data.length; i++) {
        var user = data[i];
        var rank = i + 1;
        var badgeClass = "";
        var medal = "";
        
        if (rank === 1) { 
          badgeClass = "gold"; 
          medal = "ü•á"; 
        } else if (rank === 2) { 
          badgeClass = "silver"; 
          medal = "ü•à"; 
        } else if (rank === 3) { 
          badgeClass = "bronze"; 
          medal = "ü•â"; 
        }

        var row = document.createElement("tr");
        
        // Rank cell
        var rankCell = document.createElement("td");
        rankCell.className = "rank-badge " + badgeClass;
        rankCell.textContent = rank + " " + medal;
        row.appendChild(rankCell);
        
        // Nickname cell
        var nicknameCell = document.createElement("td");
        nicknameCell.textContent = user.nickname || "‚Äî";
        row.appendChild(nicknameCell);
        
        // Email cell
        var emailCell = document.createElement("td");
        emailCell.textContent = user.email;
        row.appendChild(emailCell);
        
        // FIFA Points cell
        var fifaCell = document.createElement("td");
        fifaCell.textContent = user.fifaPoints;
        row.appendChild(fifaCell);
        
        // Snooker Points cell
        var snookerCell = document.createElement("td");
        snookerCell.textContent = user.snookerPoints;
        row.appendChild(snookerCell);
        
        // Total Points cell
        var totalCell = document.createElement("td");
        totalCell.innerHTML = "<b>" + user.totalPoints + "</b>";
        row.appendChild(totalCell);
        
        // Add Points cell
        var pointsCell = document.createElement("td");
        
        // Create select dropdown
        var select = document.createElement("select");
        select.id = "cat-" + user._id;
        
        var option1 = document.createElement("option");
        option1.value = "fifa";
        option1.textContent = "FIFA";
        select.appendChild(option1);
        
        var option2 = document.createElement("option");
        option2.value = "snooker";
        option2.textContent = "Snooker";
        select.appendChild(option2);
        
        // Create points input
        var input = document.createElement("input");
        input.type = "number";
        input.id = "points-" + user._id;
        input.className = "points-input";
        input.placeholder = "Add";
        
        // Create save button
        var button = document.createElement("button");
        button.className = "save-btn";
        button.textContent = "Save";
        button.onclick = (function(userId) {
          return function() {
            addPoints(userId);
          };
        })(user._id);
        
        pointsCell.appendChild(select);
        pointsCell.appendChild(input);
        pointsCell.appendChild(button);
        row.appendChild(pointsCell);
        
        // Date Joined cell
        var dateCell = document.createElement("td");
        if (user.createdAt) {
          var date = new Date(user.createdAt);
          dateCell.textContent = date.toLocaleDateString();
        } else {
          dateCell.textContent = "‚Äî";
        }
        row.appendChild(dateCell);
        
        tbody.appendChild(row);
      }
    }

    // Add Points to a User - This still uses admin endpoint
    function addPoints(userId) {
      if (!checkAdminAuth()) return;
      
      var adminEmail = localStorage.getItem("adminEmail");
      var categorySelect = document.getElementById("cat-" + userId);
      var pointsInput = document.getElementById("points-" + userId);
      
      var category = categorySelect.value;
      var points = parseInt(pointsInput.value);

      if (!points || points <= 0) {
        alert("Enter valid points");
        return;
      }

      // Use admin endpoint for adding points (requires session)
      fetch(API_BASE + "/admin/rank/add-points/" + userId, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          category: category, 
          points: points,
          email: adminEmail
        })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data.error) {
          throw new Error(data.error);
        }
        alert("‚úÖ " + data.message);
        pointsInput.value = ""; // Clear input
        loadRanks(); // Refresh the table
      })
      .catch(function(err) {
        console.error("Add points error:", err);
        alert("‚ùå " + err.message);
      });
    }

    // Search / Filter
    function filterUsers() {
      var search = document.getElementById("searchInput").value.toLowerCase();
      var filteredData = [];

      for (var i = 0; i < usersData.length; i++) {
        var user = usersData[i];
        var nicknameMatch = user.nickname && user.nickname.toLowerCase().indexOf(search) > -1;
        var emailMatch = user.email && user.email.toLowerCase().indexOf(search) > -1;
        
        if (nicknameMatch || emailMatch) {
          filteredData.push(user);
        }
      }

      renderTable(filteredData);
    }

    // Initialize on page load
    window.onload = function() {
      if (checkAdminAuth()) {
        loadRanks();
      }
    };
  </script>
</body>
</html>