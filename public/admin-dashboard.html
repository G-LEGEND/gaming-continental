<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      margin: 0;
      padding: 20px;
    }

    .center {
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: gold;
    }

    /* Admin Navigation */
    .admin-nav {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 20px;
      justify-items: center;
      margin-bottom: 30px;
    }

    .admin-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      cursor: pointer;
      background: transparent;
      border: none;
    }

    .admin-btn .circle {
      width: 65px;
      height: 65px;
      border-radius: 50%;
      background: gold;
      box-shadow: 0 0 12px gold, 0 0 25px rgba(255,215,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      margin-bottom: 6px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .admin-btn:hover .circle {
      transform: scale(1.1);
      box-shadow: 0 0 18px gold, 0 0 35px rgba(255,215,0,0.9);
    }

    .admin-btn span {
      color: white;
      font-size: 13px;
    }

    /* Summary */
    .summary-card {
      background: #1e293b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 18px;
      color: #f8fafc;
      box-shadow: 0 0 10px rgba(255,215,0,0.3);
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e293b;
      border-radius: 8px;
      overflow: hidden;
      color: #f8fafc;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }

    th {
      background: #0f172a;
      font-weight: bold;
    }

    tr:hover {
      background: #334155;
    }

    .muted {
      color: #9ca3af;
      font-size: 12px;
    }

    .logout-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .logout-btn:hover {
      background: #b91c1c;
    }

    .admin-info {
      background: #1e293b;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      color: #9ca3af;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }

    .error {
      color: #ef4444;
      text-align: center;
      padding: 20px;
    }

    @media (max-width: 600px) {
      th, td {
        font-size: 12px;
        padding: 8px;
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="center">
    <h1>‚öúÔ∏è Admin Dashboard</h1>

    <!-- Admin Info -->
    <div class="admin-info" id="adminInfo">
      Loading...
    </div>

    <!-- Logout Button -->
    <button class="logout-btn" onclick="logoutAdmin()">üö™ Logout</button>

    <!-- Navigation -->
    <div class="admin-nav">
      <button class="admin-btn" onclick="goPage('admin-dashboard.html')">
        <div class="circle">üè†</div><span>Dashboard</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-account.html')">
        <div class="circle">üë§</div><span>Accounts</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-bet.html')">
        <div class="circle">üé≤</div><span>Bets</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-deposit.html')">
        <div class="circle">üí≥</div><span>Deposits</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-payment-method.html')">
        <div class="circle">üè¶</div><span>Payment</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-withdraw.html')">
        <div class="circle">üèß</div><span>Withdrawals</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-live.html')">
        <div class="circle">üé¶</div><span>YouTube</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-tournament.html')">
        <div class="circle">üéÆ</div><span>Tournaments</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-rank.html')">
        <div class="circle">üìä</div><span>Ranking</span>
      </button>
      <button class="admin-btn" onclick="goPage('admin-livescores.html')">
        <div class="circle">üì∫</div><span>Live Scores</span>
      </button>
      <button class="admin-btn" onclick="goPage('settings.html')">
        <div class="circle">‚öôÔ∏è</div><span>Settings</span>
      </button>
    </div>

    <!-- Summary -->
    <div class="summary-card">
      üåç Total User Balance: <span id="totalBalance">Loading...</span>
    </div>

    <!-- User Table -->
    <div class="table-container">
      <table id="usersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>User ID</th>
            <th>Nickname</th>
            <th>Email</th>
            <th>Balance (‚Ç¶)</th>
            <th>Rank</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="6" class="loading">Loading users...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
<script>
    const API_BASE = "https://gaming-continental.onrender.com";

    // ‚úÖ Simple session check - no tokens
    function checkAdminAuth() {
      const adminEmail = localStorage.getItem("adminEmail");
      const adminLoggedIn = localStorage.getItem("adminLoggedIn");
      
      console.log("üîç Checking admin session:");
      console.log("adminEmail:", adminEmail);
      console.log("adminLoggedIn:", adminLoggedIn);
      
      if (adminLoggedIn !== "true" || !adminEmail) {
        console.log("‚ùå No admin session found, redirecting to login");
        alert("Please login as admin first");
        window.location.href = "admin.html";
        return false;
      }
      
      console.log("‚úÖ Admin session valid");
      return true;
    }

    function goPage(page) {
      if (!checkAdminAuth()) return;
      window.location.href = page;
    }

    function logoutAdmin() {
      // Also call server logout endpoint
      const adminEmail = localStorage.getItem("adminEmail");
      if (adminEmail) {
        fetch(`${API_BASE}/admin/logout`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: adminEmail })
        }).catch(console.error);
      }
      
      localStorage.removeItem("adminLoggedIn");
      localStorage.removeItem("adminEmail");
      window.location.href = "admin.html";
    }

    function updateAdminInfo() {
      const adminEmail = localStorage.getItem("adminEmail");
      const adminInfoEl = document.getElementById("adminInfo");
      
      if (adminEmail) {
        adminInfoEl.textContent = `Logged in as: ${adminEmail}`;
        adminInfoEl.style.color = "#4ade80";
      } else {
        adminInfoEl.textContent = "Not logged in";
        adminInfoEl.style.color = "#f87171";
      }
    }

    // ‚úÖ Updated fetch with admin email
    async function fetchAdminData(url, opts = {}) {
      const adminEmail = localStorage.getItem("adminEmail");
      
      if (!adminEmail) {
        throw new Error("Admin email not found");
      }

      // Ensure we have a body for POST requests, or create one for GET
      let body = opts.body;
      if (!body && opts.method === 'POST') {
        body = JSON.stringify({ email: adminEmail });
      } else if (body) {
        // Parse existing body and add email
        const parsedBody = typeof body === 'string' ? JSON.parse(body) : body;
        body = JSON.stringify({ ...parsedBody, email: adminEmail });
      }

      let res;
      try {
        res = await fetch(url, {
          headers: {
            "Content-Type": "application/json",
          },
          ...opts,
          body: body || opts.body
        });
      } catch (err) {
        throw new Error("Network error: " + (err.message || err));
      }

      // Handle 403 - Admin not logged in (session expired)
      if (res.status === 403) {
        localStorage.removeItem("adminLoggedIn");
        localStorage.removeItem("adminEmail");
        alert("Session expired. Please login again.");
        window.location.href = "admin.html";
        throw new Error("Admin session expired");
      }

      let json;
      try { 
        json = await res.json(); 
      } catch { 
        json = null; 
      }

      if (!res.ok) {
        const msg = (json && (json.error || json.message)) || res.statusText || "Request failed";
        throw new Error(msg);
      }

      return json;
    }

    async function loadUsers() {
      // Check authentication first
      if (!checkAdminAuth()) return;

      try {
        console.log("üì° Loading users from API...");
        
        // Try different possible endpoints
        const endpoints = [
          '/admin/users',
          '/user/all'
        ];

        let users = [];
        let workingEndpoint = '';

        // Try each endpoint until one works
        for (let endpoint of endpoints) {
          try {
            console.log(`üîÑ Trying endpoint: ${API_BASE}${endpoint}`);
            
            // For admin endpoints, we need to send the email
            if (endpoint.startsWith('/admin/')) {
              const data = await fetchAdminData(`${API_BASE}${endpoint}`, {
                method: 'POST',
                body: JSON.stringify({}) // Email will be added automatically
              });
              users = data;
            } else {
              // For public endpoints, use regular fetch
              const data = await fetch(`${API_BASE}${endpoint}`);
              if (!data.ok) throw new Error('Endpoint failed');
              users = await data.json();
            }
            
            workingEndpoint = endpoint;
            console.log(`‚úÖ Success with ${endpoint}`);
            break;
          } catch (err) {
            console.log(`‚ùå Failed with ${endpoint}:`, err.message);
          }
        }

        // If no endpoint worked, show error
        if (users.length === 0 && !workingEndpoint) {
          throw new Error('No working users endpoint found');
        }

        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";

        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; color: #9ca3af;">
                No users found
              </td>
            </tr>
          `;
          document.getElementById("totalBalance").textContent = "‚Ç¶0";
          return;
        }

        let total = 0;
        users.forEach((u, i) => {
          total += u.balance || 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td class="muted">${u._id ? u._id.substring(0, 8) + '...' : 'N/A'}</td>
            <td>${u.nickname || "‚Äî"}</td>
            <td>${u.email || "‚Äî"}</td>
            <td>‚Ç¶${(u.balance || 0).toLocaleString()}</td>
            <td>${u.rank || "-"}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("totalBalance").textContent = 
          `‚Ç¶${total.toLocaleString()}`;

      } catch (err) {
        console.error("‚ùå Failed to load users:", err);
        
        // Don't show error if it's due to session expiry (already handled)
        if (err.message !== "Admin session expired") {
          document.getElementById("totalBalance").textContent = "Error loading data";
          
          const tbody = document.querySelector("#usersTable tbody");
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="error">
                Failed to load users: ${err.message}
                <br><br>
                <button onclick="loadUsers()" style="background: #38bdf8; margin-top: 10px;">
                  üîÑ Retry
                </button>
              </td>
            </tr>
          `;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      console.log("üöÄ Admin dashboard loaded");
      
      // Check authentication on page load
      if (!checkAdminAuth()) return;
      
      // Update admin info display
      updateAdminInfo();
      
      // Load users
      loadUsers();
    })
    
    
    
  </script>
  
</body>
</html>